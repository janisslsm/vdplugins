(function(p,a,r,C,t,w,g,h,P,v,l,I,J){"use strict";const B="915703782174752809",S="https://manti.vendicated.dev",d=S+"/api/reviewdb";var X=Object.freeze({__proto__:null,API_URL:d,BASE_URL:S,CLIENT_ID:B});const{getCurrentUser:N}=r.findByStoreName("UserStore"),Y=r.find(function(e){return e.default?.internal?.resolveSemanticColor})?.default.internal.resolveSemanticColor??r.find(function(e){return e.meta?.resolveSemanticColor})?.meta.resolveSemanticColor??function(){},{useThemeContext:G}=r.findByProps("useThemeContext"),D=function(e){return e.sender.discordID===N()?.id||b.includes(N()?.id)};async function u(e,n){const o=await(await fetch(e,{headers:{"content-type":"application/json",accept:"application/json"},...n})).json();if(o.success===!1)throw new Error(o.message);return o}const y=function(e){return Y(G()?.theme??"dark",C.semanticColors[e])};var W=Object.freeze({__proto__:null,canDeleteReview:D,jsonFetch:u,useThemedColor:y});const _=async function(e){return(await u(d+`/users/${e}/reviews`)).reviews},$=async function(){return await u(S+"/admins")},x=async function(e,n){return await u(d+`/users/${e}/reviews`,{method:"PUT",body:JSON.stringify({comment:n,token:a.storage.authToken})})},U=async function(e,n){return await u(d+`/users/${e}/reviews`,{method:"DELETE",body:JSON.stringify({reviewid:n,token:a.storage.authToken})})},L=async function(e){return await u(d+"/reports",{method:"PUT",body:JSON.stringify({reviewid:e,token:a.storage.authToken})})};var q=Object.freeze({__proto__:null,addReview:x,deleteReview:U,getAdmins:$,getCurrentUser:async function(){return await u(d+"/users",{method:"POST",body:JSON.stringify({token:a.storage.authToken})})},getReviews:_,reportReview:L});const{hideActionSheet:K}=r.findByProps("openLazy","hideActionSheet"),{showSimpleActionSheet:Q}=r.findByProps("showSimpleActionSheet");function k(e){return Q({key:"ReviewOverflow",header:{title:e.type!==3?`Review by ${e.sender.username}`:"ReviewDB System Message",onClose:function(){return K()}},options:[{label:"Copy Text",onPress:function(){t.clipboard.setString(e.comment),v.showToast("Copied Review Text",l.getAssetIDByName("ic_message_copy"))}},...a.storage.authToken&&e.type!==3?[...D(e)?[{label:"Delete Review",isDestructive:!0,onPress:function(){return P.showConfirmationAlert({title:"Delete Review",content:"Are you sure you want to delete this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return U(e.sender.discordID,e.id)}})}}]:[],{label:"Report Review",isDestructive:!0,onPress:function(){return P.showConfirmationAlert({title:"Report Review",content:"Are you sure you want to report this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return L(e.id)}})}}]:[]]})}function Z({badge:e}){return React.createElement(t.ReactNative.Pressable,{style:{marginLeft:4},onPress:function(){v.showToast(e.name,{uri:e.icon})}},React.createElement(t.ReactNative.Image,{source:{uri:e.icon,width:16,height:16}}))}const M=t.stylesheet.createThemedStyleSheet({row:{flexDirection:"row",alignItems:"center"}}),{FormLabel:ee}=h.Forms;function te({username:e,badges:n}){return React.createElement(t.ReactNative.View,{style:M.row},React.createElement(ee,{text:e,style:{color:y("TEXT_NORMAL")}}),React.createElement(t.ReactNative.View,{style:M.row},n.map(function(o){return React.createElement(Z,{badge:o})})))}const ne=t.stylesheet.createThemedStyleSheet({avatar:{height:36,width:36,borderRadius:18}}),{FormRow:re,FormSubLabel:oe}=h.Forms;function ae({review:e}){return React.createElement(re,{label:React.createElement(te,{username:e.sender.username,badges:e.sender.badges}),subLabel:React.createElement(oe,{text:e.comment,style:{color:y("TEXT_NORMAL")}}),leading:React.createElement(t.ReactNative.Image,{style:ne.avatar,source:{uri:e.sender.profilePhoto}}),onLongPress:function(){return k(e)}})}const T=t.stylesheet.createThemedStyleSheet({container:{flex:1,flexDirection:"row",alignItems:"center",justifyContent:"center",paddingHorizontal:8,paddingVertical:4},textInput:{flex:1,flexGrow:1,fontSize:16,fontFamily:t.constants.Fonts.DISPLAY_MEDIUM},sendButton:{flexShrink:1,flexDirection:"row",alignItems:"center",justifyContent:"center",minHeight:40,minWidth:40,borderRadius:999}}),{useThemeContext:ie}=r.findByProps("useThemeContext");function se({userId:e,shouldEdit:n,refetch:o}){I.useProxy(a.storage);const[i,c]=t.React.useState(""),s=!a.storage.authToken,H=!a.storage.authToken||i.length===0;return t.React.createElement(t.ReactNative.View,{style:T.container},t.React.createElement(t.ReactNative.TextInput,{style:{...T.textInput,color:y("TEXT_NORMAL")},editable:!s,placeholder:s?"You must be authenticated to add a review.":`Tap to ${n?"edit your":"add a"} review`,placeholderTextColor:y("INPUT_PLACEHOLDER_TEXT"),value:i,onChangeText:function(R){return c(R)}}),t.React.createElement(t.ReactNative.Pressable,{style:{...T.sendButton,backgroundColor:a.storage.useThemedSend&&ie().primaryColor||C.rawColors.BRAND_500,opacity:H?.25:1},disabled:H,onPress:function(){x(e,i).then(function(R){c(""),o(),v.showToast(R.message,l.getAssetIDByName("Check"))}).catch(function(R){return v.showToast(R.message,l.getAssetIDByName("Small"))})}},t.React.createElement(t.ReactNative.Image,{style:{tintColor:"#fff"},source:l.getAssetIDByName("ic_send")})))}const{getCurrentUser:ce}=r.findByStoreName("UserStore"),ue=r.findByName("UserProfileSection");function E({userId:e}){const[n,o]=t.React.useState([]),i=function(){_(e).then(function(s){return o(s)})};t.React.useEffect(i,[]);const c=n.filter(function(s){return s.sender.discordID===ce()?.id}).length!==0;return t.React.createElement(h.ErrorBoundary,null,t.React.createElement(ue,{title:"Reviews",showContainer:!0},t.React.createElement(t.ReactNative.View,{style:{flex:1}},n.map(function(s){return t.React.createElement(ae,{review:s})})),t.React.createElement(se,{userId:e,refetch:i,shouldEdit:c})))}let A=r.findByTypeName("UserProfile");A===void 0&&(A=r.findByTypeName("UserProfileContent"));function le(){return w.after("type",A,function(e,n){const o=g.findInReactTree(n,function(c){return c?.type?.displayName==="View"&&c?.props?.children.findIndex(function(s){return s?.type?.name==="UserProfileBio"||s?.type?.name==="UserProfileAboutMeCard"})!==-1})?.props?.children;let i=e[0]?.userId;i===void 0&&(i=e[0]?.user?.id),o?.push(t.React.createElement(E,{userId:i}))})}const{pushModal:de,popModal:z}=r.findByProps("pushModal"),fe=r.findByName("OAuth2AuthorizeModal");function F(){return de({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:fe,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:B,redirectUri:d+"/auth",scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function({location:e}){try{const n=new URL(e);n.searchParams.append("returnType","json"),n.searchParams.append("clientMod","vendetta");const{token:o,success:i,message:c}=await u(n,{headers:{accept:"application/json"}});if(i)a.storage.authToken=o;else throw z("oauth2-authorize"),new Error(c)}catch(n){J.logger.error("Authorization failed!",n)}},dismissOAuthModal:function(){return z("oauth2-authorize")}},closable:!0}})}function he(){return globalThis.vendettaRDB={api:q,utils:{...W,showAuthModal:F,showReviewActionSheet:k},constants:X},function(){return delete globalThis.vendettaRDB}}const O=r.findByTypeName("SimplifiedUserProfileContent");function ye(){return O!==void 0?w.after("type",O,function(e,n){const o=g.findInReactTree(n,function(c){return c?.type?.displayName==="View"&&c?.props?.children.findIndex(function(s){return s?.type?.name==="SimplifiedUserProfileAboutMeCard"})!==-1})?.props?.children,i=e[0]?.user?.id;o?.push(t.React.createElement(E,{userId:i}))}):function(){}}const Re=r.findByProps("ActionSheet")?.ActionSheet??r.find(function(e){return e.render?.name==="ActionSheet"}),{ActionSheetTitleHeader:pe,ActionSheetCloseButton:we}=r.findByProps("ActionSheetTitleHeader","ActionSheetCloseButton"),ve=r.findByProps("openLazy","hideActionSheet"),{openLazy:me,hideActionSheet:ge}=ve;r.findByProps("showSimpleActionSheet");const m=function(e){return React.createElement(Re,null,React.createElement(pe,{title:e.title,trailing:React.createElement(we,{onPress:e.onClose??function(){ge()}})}),React.createElement(t.ReactNative.View,g.without(e,"title","onClose")))};m.open=function(e,n){me(new Promise(function(o){o({default:e})}),"ActionSheet",n)};function j({userId:e}){return t.React.createElement(m,{title:"Reviews"},t.React.createElement(t.ReactNative.ScrollView,{style:{gap:12,marginBottom:12}},t.React.createElement(E,{userId:e})))}const{TableRow:Se}=r.findByProps("TableRow");function Te({userId:e}){return t.React.createElement(h.ErrorBoundary,null,t.React.createElement(Se,{label:"Reviews",onPress:function(){m.open(j,{userId:e})}}))}let Ee=r.findByProps("GuildActionSheetPrimaryActions");function Ae(){return w.after("GuildActionSheetPrimaryActions",Ee,function(e,n){const o=e[0]?.guild?.id;n?.props?.children?.push(t.React.createElement(Te,{userId:o}))})}let be=r.findByProps("ContextMenuPopout");function Ce(){return w.before("ContextMenuPopout",be,function(e){const n=e[0]?.menu?.key;n!==void 0&&e[0].menu.items.push({label:"Reviews",action:function(){m.open(j,{userId:n})}})})}const{FormSection:V,FormRow:f,FormSwitchRow:Pe,FormDivider:Ie}=h.Forms;function Be(){return I.useProxy(a.storage),React.createElement(t.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},React.createElement(V,{title:"Authentication",titleStyleType:"no_border"},React.createElement(f,{label:"Authenticate with ReviewDB",leading:React.createElement(f.Icon,{source:l.getAssetIDByName("copy")}),trailing:f.Arrow,onPress:F}),React.createElement(Ie,null),React.createElement(f,{label:"Log out of ReviewDB",subLabel:"Note that this does not remove ReviewDB from your Authorized Apps page in Discord.",leading:React.createElement(f.Icon,{source:l.getAssetIDByName("ic_logout_24px")}),disabled:a.storage.authToken.length===0,onPress:function(){return a.storage.authToken=""}})),React.createElement(V,{title:"Settings"},React.createElement(Pe,{label:"Use profile-themed send button",subLabel:"Controls whether the review send button should attempt to match the user's profile colors.",leading:React.createElement(f.Icon,{source:l.getAssetIDByName("ic_paint_brush")}),value:a.storage.useThemedSend,onValueChange:function(e){return a.storage.useThemedSend=e}})))}a.storage.authToken??="",a.storage.useThemedSend??=!0;const Ne=[he(),le(),ye(),Ae(),Ce()],b=[];$().then(function(e){return b.push(...e)});const De=function(){return Ne.forEach(function(e){return e()})};return p.admins=b,p.onUnload=De,p.settings=Be,p})({},vendetta.plugin,vendetta.metro,vendetta.ui,vendetta.metro.common,vendetta.patcher,vendetta.utils,vendetta.ui.components,vendetta.ui.alerts,vendetta.ui.toasts,vendetta.ui.assets,vendetta.storage,vendetta);
